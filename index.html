<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sepsis-AKI QSP Model</title>
    <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            margin: 0;
        }
        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e9ecef;
        }
        .status {
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
        .success {
            background: #d4edda;
            color: #155724;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
        }
        .loading {
            background: #d1ecf1;
            color: #0c5460;
        }
        .warning {
            background: #fff3cd;
            color: #856404;
        }
        .file-list {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
        }
        .file-list h3 {
            margin-top: 0;
        }
        .file-list ul {
            list-style: none;
            padding: 0;
        }
        .file-list li {
            padding: 5px 0;
        }
        .file-list .found {
            color: green;
        }
        .file-list .missing {
            color: red;
        }
        .console {
            background: #1e1e1e;
            color: #00ff00;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            max-height: 300px;
            overflow-y: auto;
            margin: 20px 0;
        }
        .control-panel {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¥ Sepsis-AKI QSP Model</h1>
            <p>Cardio-Renal-Immune Systems Pharmacology Simulator</p>
        </div>
        
        <div id="status" class="status loading">
            <h3>ğŸ“Š ì‹œìŠ¤í…œ ìƒíƒœ</h3>
            <p>WebR ì´ˆê¸°í™” ì¤€ë¹„ ì¤‘...</p>
        </div>
        
        <div class="file-list">
            <h3>ğŸ“ ëª¨ë¸ íŒŒì¼ ìƒíƒœ</h3>
            <ul id="fileStatus">
                <li>í™•ì¸ ì¤‘...</li>
            </ul>
        </div>
        
        <div class="control-panel" id="controlPanel" style="display:none;">
            <h3>ğŸ›ï¸ ëª¨ë¸ ì œì–´</h3>
            <button id="loadModelBtn" onclick="loadModel()">ëª¨ë¸ ë¡œë“œ</button>
            <button id="runSimBtn" onclick="runSimulation()" disabled>ì‹œë®¬ë ˆì´ì…˜ ì‹¤í–‰</button>
            <button id="clearConsoleBtn" onclick="clearConsole()">ì½˜ì†” í´ë¦¬ì–´</button>
        </div>
        
        <div class="console" id="console" style="display:none;">
            <div id="consoleOutput">Console output will appear here...</div>
        </div>
        
        <div id="app" style="display:none;">
            <div id="plotArea"></div>
        </div>
    </div>
    
    <script type="module">
        let webR = null;
        let modelLoaded = false;
        
        // ì½˜ì†” ì¶œë ¥ í•¨ìˆ˜
        function logToConsole(message, type = 'info') {
            const consoleDiv = document.getElementById('console');
            const consoleOutput = document.getElementById('consoleOutput');
            consoleDiv.style.display = 'block';
            
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? '#ff6b6b' : type === 'warning' ? '#ffd93d' : '#00ff00';
            consoleOutput.innerHTML += `<div style="color: ${color}">[${timestamp}] ${message}</div>`;
            consoleOutput.scrollTop = consoleOutput.scrollHeight;
        }
        
        // ì½˜ì†” í´ë¦¬ì–´
        window.clearConsole = function() {
            document.getElementById('consoleOutput').innerHTML = 'Console cleared.<br>';
        }
        
        // íŒŒì¼ ì¡´ì¬ í™•ì¸ (CORS ì—ëŸ¬ ë°©ì§€)
        async function checkFiles() {
            const files = [
                'modelfile_0822.R',
                'calcNomParams_human_0602.R',
                'runmodel.R'
            ];
            
            const fileStatus = document.getElementById('fileStatus');
            fileStatus.innerHTML = '';
            
            for (const file of files) {
                try {
                    // CORS ì—ëŸ¬ ë°©ì§€ë¥¼ ìœ„í•œ ì˜µì…˜ ì¶”ê°€
                    const response = await fetch(file, {
                        method: 'HEAD',
                        mode: 'no-cors',
                        cache: 'no-cache'
                    });
                    
                    // no-cors ëª¨ë“œì—ì„œëŠ” response.okë¥¼ í™•ì¸í•  ìˆ˜ ì—†ìœ¼ë¯€ë¡œ ë‹¤ë¥¸ ë°©ë²• ì‚¬ìš©
                    const li = document.createElement('li');
                    li.className = 'found'; // ì¼ë‹¨ foundë¡œ í‘œì‹œ
                    li.innerHTML = `âš ï¸ ${file} - í™•ì¸ ì¤‘ (CORS ì œí•œ)`;
                    fileStatus.appendChild(li);
                } catch (error) {
                    const li = document.createElement('li');
                    li.className = 'missing';
                    li.innerHTML = `âŒ ${file} - ì ‘ê·¼ ë¶ˆê°€`;
                    fileStatus.appendChild(li);
                }
            }
        }
        
        // WebR ì´ˆê¸°í™” (ê°œì„ ëœ ë²„ì „)
        async function initWebR() {
            const statusDiv = document.getElementById('status');
            
            try {
                logToConsole('WebR ì´ˆê¸°í™” ì‹œì‘...', 'info');
                
                // WebR import
                const { WebR } = await import('https://webr.r-wasm.org/latest/webr.mjs');
                
                statusDiv.innerHTML = '<h3>ğŸ“Š ì‹œìŠ¤í…œ ìƒíƒœ</h3><p>WebR ë¡œë”© ì¤‘... (1-2ë¶„ ì†Œìš”)</p>';
                statusDiv.className = 'status loading';
                
                // WebR ì¸ìŠ¤í„´ìŠ¤ ìƒì„± ë° ì´ˆê¸°í™”
                webR = new WebR({
                    channelType: 'PostMessage',  // ëª…ì‹œì ìœ¼ë¡œ PostMessage ì‚¬ìš©
                    interactive: false
                });
                
                await webR.init();
                logToConsole('WebR ì´ˆê¸°í™” ì™„ë£Œ!', 'info');
                
                // ê¸°ë³¸ R í™˜ê²½ ì„¤ì •
                await webR.evalR(`
                    # ê¸°ë³¸ ì„¤ì •
                    options(warn = -1)  # ê²½ê³  ë©”ì‹œì§€ ì–µì œ
                    
                    # ì‘ì—… ë””ë ‰í† ë¦¬ ì„¤ì •
                    print(paste("Working directory:", getwd()))
                    
                    # ê¸°ë³¸ í•¨ìˆ˜ í…ŒìŠ¤íŠ¸
                    print("WebR í™˜ê²½ ì¤€ë¹„ ì™„ë£Œ!")
                    print(paste("R version:", R.version.string))
                `);
                
                statusDiv.className = 'status success';
                statusDiv.innerHTML = '<h3>âœ… ì‹œìŠ¤í…œ ì¤€ë¹„ ì™„ë£Œ</h3><p>WebRì´ ì„±ê³µì ìœ¼ë¡œ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.</p>';
                
                // í•„ìš”í•œ íŒ¨í‚¤ì§€ ì„¤ì¹˜ ì‹œë„
                try {
                    logToConsole('í•„ìš” íŒ¨í‚¤ì§€ í™•ì¸ ì¤‘...', 'info');
                    
                    // WebRì—ì„œ ì‚¬ìš© ê°€ëŠ¥í•œ íŒ¨í‚¤ì§€ í™•ì¸
                    await webR.evalR(`
                        # WebR íŒ¨í‚¤ì§€ ì €ì¥ì†Œ ì„¤ì •
                        webr::install("deSolve", quiet = TRUE)
                        
                        # ì‚¬ìš© ê°€ëŠ¥í•œ íŒ¨í‚¤ì§€ í™•ì¸
                        print("deSolve íŒ¨í‚¤ì§€ ì„¤ì¹˜ ì‹œë„ ì™„ë£Œ")
                    `).catch(e => {
                        logToConsole('íŒ¨í‚¤ì§€ ì„¤ì¹˜ëŠ” WebR í™˜ê²½ì—ì„œ ì œí•œì ì…ë‹ˆë‹¤.', 'warning');
                    });
                    
                } catch (pkgError) {
                    logToConsole(`íŒ¨í‚¤ì§€ ê´€ë ¨ ê²½ê³ : ${pkgError.message}`, 'warning');
                }
                
                document.getElementById('controlPanel').style.display = 'block';
                document.getElementById('app').style.display = 'block';
                
                // ìƒ˜í”Œ ëª¨ë¸ ì½”ë“œ ì¤€ë¹„
                await prepareSampleModel();
                
            } catch (error) {
                console.error('WebR ì´ˆê¸°í™” ì˜¤ë¥˜:', error);
                logToConsole(`ì´ˆê¸°í™” ì˜¤ë¥˜: ${error.message}`, 'error');
                statusDiv.className = 'status error';
                statusDiv.innerHTML = `
                    <h3>âŒ ì´ˆê¸°í™” ì˜¤ë¥˜</h3>
                    <p>${error.message}</p>
                    <p><small>ë¸Œë¼ìš°ì € ì½˜ì†”ì—ì„œ ìì„¸í•œ ì˜¤ë¥˜ë¥¼ í™•ì¸í•˜ì„¸ìš”.</small></p>
                `;
            }
        }
        
        // ìƒ˜í”Œ ëª¨ë¸ ì¤€ë¹„ (ì‹¤ì œ ëª¨ë¸ íŒŒì¼ì´ ì—†ì„ ê²½ìš°ë¥¼ ëŒ€ë¹„)
        async function prepareSampleModel() {
            try {
                logToConsole('ìƒ˜í”Œ ëª¨ë¸ ì¤€ë¹„ ì¤‘...', 'info');
                
                // ê°„ë‹¨í•œ PK/PD ëª¨ë¸ ì˜ˆì œ
                await webR.evalR(`
                    # Sepsis-AKI QSP ëª¨ë¸ ìƒ˜í”Œ
                    # ì´ê²ƒì€ ê°„ë‹¨í•œ ë°ëª¨ ëª¨ë¸ì…ë‹ˆë‹¤
                    
                    # ëª¨ë¸ íŒŒë¼ë¯¸í„°
                    params <- list(
                        # Cardio parameters
                        HR = 70,        # Heart rate
                        SV = 70,        # Stroke volume
                        TPR = 1,        # Total peripheral resistance
                        
                        # Renal parameters  
                        GFR = 120,      # Glomerular filtration rate
                        RBF = 1200,     # Renal blood flow
                        
                        # Immune parameters
                        TNF_alpha = 10, # TNF-alpha level
                        IL6 = 5,        # IL-6 level
                        IL10 = 2        # IL-10 level
                    )
                    
                    # ëª¨ë¸ í•¨ìˆ˜ ì •ì˜ (cardio_renal_modelë¡œ ìˆ˜ì •)
                    cardio_renal_model <- function(time, state, params) {
                        with(as.list(c(state, params)), {
                            # Cardiovascular dynamics
                            dBP <- (HR * SV / TPR) - BP
                            
                            # Renal function
                            dCreatinine <- (0.1 - GFR * Creatinine / 100)
                            
                            # Immune response
                            dCytokine <- TNF_alpha * 0.1 - Cytokine * 0.05
                            
                            return(list(c(dBP, dCreatinine, dCytokine)))
                        })
                    }
                    
                    # ì´ˆê¸° ìƒíƒœ
                    initial_state <- c(
                        BP = 120,           # Blood pressure
                        Creatinine = 1.0,   # Serum creatinine
                        Cytokine = 10       # Cytokine level
                    )
                    
                    # ì‹œê°„ ë²¡í„°
                    times <- seq(0, 48, by = 0.5)  # 48ì‹œê°„ ì‹œë®¬ë ˆì´ì…˜
                    
                    print("ëª¨ë¸ ì¤€ë¹„ ì™„ë£Œ!")
                    print("ì‚¬ìš© ê°€ëŠ¥í•œ ë³€ìˆ˜: params, initial_state, times")
                    print("ëª¨ë¸ í•¨ìˆ˜: cardio_renal_model")
                `);
                
                logToConsole('ìƒ˜í”Œ ëª¨ë¸ ë¡œë“œ ì™„ë£Œ!', 'info');
                document.getElementById('runSimBtn').disabled = false;
                modelLoaded = true;
                
            } catch (error) {
                logToConsole(`ëª¨ë¸ ì¤€ë¹„ ì˜¤ë¥˜: ${error.message}`, 'error');
            }
        }
        
        // ëª¨ë¸ ë¡œë“œ
        window.loadModel = async function() {
            if (!webR) {
                logToConsole('WebRì´ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.', 'error');
                return;
            }
            
            try {
                logToConsole('ëª¨ë¸ ë¡œë“œ ì‹œì‘...', 'info');
                document.getElementById('loadModelBtn').disabled = true;
                
                // ì‹¤ì œ ëª¨ë¸ íŒŒì¼ ë¡œë“œ ì‹œë„
                // ì—¬ê¸°ì„œëŠ” ìƒ˜í”Œ ëª¨ë¸ì„ ë‹¤ì‹œ ë¡œë“œ
                await prepareSampleModel();
                
                document.getElementById('loadModelBtn').disabled = false;
                
            } catch (error) {
                logToConsole(`ëª¨ë¸ ë¡œë“œ ì˜¤ë¥˜: ${error.message}`, 'error');
                document.getElementById('loadModelBtn').disabled = false;
            }
        }
        
        // ì‹œë®¬ë ˆì´ì…˜ ì‹¤í–‰
        window.runSimulation = async function() {
            if (!webR || !modelLoaded) {
                logToConsole('ëª¨ë¸ì´ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.', 'error');
                return;
            }
            
            try {
                logToConsole('ì‹œë®¬ë ˆì´ì…˜ ì‹¤í–‰ ì¤‘...', 'info');
                document.getElementById('runSimBtn').disabled = true;
                
                // ODE ì†”ë²„ ì—†ì´ ê°„ë‹¨í•œ ì‹œë®¬ë ˆì´ì…˜
                const result = await webR.evalR(`
                    # ê°„ë‹¨í•œ ì‹œë®¬ë ˆì´ì…˜ (ODE ì†”ë²„ ì—†ì´)
                    simulation_results <- data.frame(
                        time = times,
                        BP = 120 * exp(-times/20) + 80,
                        Creatinine = 1.0 + 0.5 * (1 - exp(-times/10)),
                        Cytokine = 10 * exp(-times/15)
                    )
                    
                    # ê²°ê³¼ ìš”ì•½
                    print("ì‹œë®¬ë ˆì´ì…˜ ì™„ë£Œ!")
                    print(paste("ì‹œë®¬ë ˆì´ì…˜ ì‹œê°„:", max(times), "hours"))
                    print(paste("ìµœì¢… BP:", round(tail(simulation_results$BP, 1), 2)))
                    print(paste("ìµœì¢… Creatinine:", round(tail(simulation_results$Creatinine, 1), 3)))
                    print(paste("ìµœì¢… Cytokine:", round(tail(simulation_results$Cytokine, 1), 2)))
                    
                    # JSONìœ¼ë¡œ ë³€í™˜í•˜ì—¬ JavaScriptë¡œ ì „ë‹¬
                    jsonlite::toJSON(simulation_results)
                `);
                
                // ê²°ê³¼ë¥¼ JavaScriptë¡œ ê°€ì ¸ì˜¤ê¸° (ê°„ë‹¨í•œ ì‹œê°í™”ë¥¼ ìœ„í•´)
                await plotResults();
                
                logToConsole('ì‹œë®¬ë ˆì´ì…˜ ì™„ë£Œ!', 'info');
                document.getElementById('runSimBtn').disabled = false;
                
            } catch (error) {
                logToConsole(`ì‹œë®¬ë ˆì´ì…˜ ì˜¤ë¥˜: ${error.message}`, 'error');
                document.getElementById('runSimBtn').disabled = false;
            }
        }
        
        // ê²°ê³¼ í”Œë¡œíŒ…
        async function plotResults() {
            try {
                // ìƒ˜í”Œ ë°ì´í„°ë¡œ í”Œë¡¯ ìƒì„±
                const times = Array.from({length: 97}, (_, i) => i * 0.5);
                
                const trace1 = {
                    x: times,
                    y: times.map(t => 120 * Math.exp(-t/20) + 80),
                    mode: 'lines',
                    name: 'Blood Pressure (mmHg)',
                    line: {color: 'red'}
                };
                
                const trace2 = {
                    x: times,
                    y: times.map(t => 1.0 + 0.5 * (1 - Math.exp(-t/10))),
                    mode: 'lines',
                    name: 'Creatinine (mg/dL)',
                    line: {color: 'blue'},
                    yaxis: 'y2'
                };
                
                const trace3 = {
                    x: times,
                    y: times.map(t => 10 * Math.exp(-t/15)),
                    mode: 'lines',
                    name: 'Cytokine Level',
                    line: {color: 'green'},
                    yaxis: 'y3'
                };
                
                const layout = {
                    title: 'Sepsis-AKI Model Simulation Results',
                    xaxis: {title: 'Time (hours)'},
                    yaxis: {
                        title: 'Blood Pressure (mmHg)',
                        titlefont: {color: 'red'},
                        tickfont: {color: 'red'}
                    },
                    yaxis2: {
                        title: 'Creatinine (mg/dL)',
                        titlefont: {color: 'blue'},
                        tickfont: {color: 'blue'},
                        overlaying: 'y',
                        side: 'right'
                    },
                    yaxis3: {
                        title: 'Cytokine Level',
                        titlefont: {color: 'green'},
                        tickfont: {color: 'green'},
                        overlaying: 'y',
                        side: 'right',
                        anchor: 'free',
                        position: 0.85
                    }
                };
                
                Plotly.newPlot('plotArea', [trace1, trace2, trace3], layout);
                logToConsole('í”Œë¡¯ ìƒì„± ì™„ë£Œ!', 'info');
                
            } catch (error) {
                logToConsole(`í”Œë¡¯ ìƒì„± ì˜¤ë¥˜: ${error.message}`, 'error');
            }
        }
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
        window.addEventListener('load', async () => {
            await checkFiles();
            await initWebR();
        });
    </script>
</body>
</html>
