<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sepsis-AKI QSP Model</title>
    <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            margin: 0;
        }
        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e9ecef;
        }
        .status {
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
        .success {
            background: #d4edda;
            color: #155724;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
        }
        .loading {
            background: #d1ecf1;
            color: #0c5460;
        }
        .warning {
            background: #fff3cd;
            color: #856404;
        }
        .file-list {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
        }
        .file-list h3 {
            margin-top: 0;
        }
        .file-list ul {
            list-style: none;
            padding: 0;
        }
        .file-list li {
            padding: 5px 0;
        }
        .file-list .found {
            color: green;
        }
        .file-list .missing {
            color: red;
        }
        .console {
            background: #1e1e1e;
            color: #00ff00;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            max-height: 300px;
            overflow-y: auto;
            margin: 20px 0;
        }
        .control-panel {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🏥 Sepsis-AKI QSP Model</h1>
            <p>Cardio-Renal-Immune Systems Pharmacology Simulator</p>
        </div>
        
        <div id="status" class="status loading">
            <h3>📊 시스템 상태</h3>
            <p>WebR 초기화 준비 중...</p>
        </div>
        
        <div class="file-list">
            <h3>📁 모델 파일 상태</h3>
            <ul id="fileStatus">
                <li>확인 중...</li>
            </ul>
        </div>
        
        <div class="control-panel" id="controlPanel" style="display:none;">
            <h3>🎛️ 모델 제어</h3>
            <button id="loadModelBtn" onclick="loadModel()">모델 로드</button>
            <button id="runSimBtn" onclick="runSimulation()" disabled>시뮬레이션 실행</button>
            <button id="clearConsoleBtn" onclick="clearConsole()">콘솔 클리어</button>
        </div>
        
        <div class="console" id="console" style="display:none;">
            <div id="consoleOutput">Console output will appear here...</div>
        </div>
        
        <div id="app" style="display:none;">
            <div id="plotArea"></div>
        </div>
    </div>
    
    <script type="module">
        let webR = null;
        let modelLoaded = false;
        
        // 콘솔 출력 함수
        function logToConsole(message, type = 'info') {
            const consoleDiv = document.getElementById('console');
            const consoleOutput = document.getElementById('consoleOutput');
            consoleDiv.style.display = 'block';
            
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? '#ff6b6b' : type === 'warning' ? '#ffd93d' : '#00ff00';
            consoleOutput.innerHTML += `<div style="color: ${color}">[${timestamp}] ${message}</div>`;
            consoleOutput.scrollTop = consoleOutput.scrollHeight;
        }
        
        // 콘솔 클리어
        window.clearConsole = function() {
            document.getElementById('consoleOutput').innerHTML = 'Console cleared.<br>';
        }
        
        // 파일 존재 확인 (CORS 에러 방지)
        async function checkFiles() {
            const files = [
                'modelfile_0822.R',
                'calcNomParams_human_0602.R',
                'runmodel.R'
            ];
            
            const fileStatus = document.getElementById('fileStatus');
            fileStatus.innerHTML = '';
            
            for (const file of files) {
                try {
                    // CORS 에러 방지를 위한 옵션 추가
                    const response = await fetch(file, {
                        method: 'HEAD',
                        mode: 'no-cors',
                        cache: 'no-cache'
                    });
                    
                    // no-cors 모드에서는 response.ok를 확인할 수 없으므로 다른 방법 사용
                    const li = document.createElement('li');
                    li.className = 'found'; // 일단 found로 표시
                    li.innerHTML = `⚠️ ${file} - 확인 중 (CORS 제한)`;
                    fileStatus.appendChild(li);
                } catch (error) {
                    const li = document.createElement('li');
                    li.className = 'missing';
                    li.innerHTML = `❌ ${file} - 접근 불가`;
                    fileStatus.appendChild(li);
                }
            }
        }
        
        // WebR 초기화 (개선된 버전)
        async function initWebR() {
            const statusDiv = document.getElementById('status');
            
            try {
                logToConsole('WebR 초기화 시작...', 'info');
                
                // WebR import
                const { WebR } = await import('https://webr.r-wasm.org/latest/webr.mjs');
                
                statusDiv.innerHTML = '<h3>📊 시스템 상태</h3><p>WebR 로딩 중... (1-2분 소요)</p>';
                statusDiv.className = 'status loading';
                
                // WebR 인스턴스 생성 및 초기화
                webR = new WebR({
                    channelType: 'PostMessage',  // 명시적으로 PostMessage 사용
                    interactive: false
                });
                
                await webR.init();
                logToConsole('WebR 초기화 완료!', 'info');
                
                // 기본 R 환경 설정
                await webR.evalR(`
                    # 기본 설정
                    options(warn = -1)  # 경고 메시지 억제
                    
                    # 작업 디렉토리 설정
                    print(paste("Working directory:", getwd()))
                    
                    # 기본 함수 테스트
                    print("WebR 환경 준비 완료!")
                    print(paste("R version:", R.version.string))
                `);
                
                statusDiv.className = 'status success';
                statusDiv.innerHTML = '<h3>✅ 시스템 준비 완료</h3><p>WebR이 성공적으로 초기화되었습니다.</p>';
                
                // 필요한 패키지 설치 시도
                try {
                    logToConsole('필요 패키지 확인 중...', 'info');
                    
                    // WebR에서 사용 가능한 패키지 확인
                    await webR.evalR(`
                        # WebR 패키지 저장소 설정
                        webr::install("deSolve", quiet = TRUE)
                        
                        # 사용 가능한 패키지 확인
                        print("deSolve 패키지 설치 시도 완료")
                    `).catch(e => {
                        logToConsole('패키지 설치는 WebR 환경에서 제한적입니다.', 'warning');
                    });
                    
                } catch (pkgError) {
                    logToConsole(`패키지 관련 경고: ${pkgError.message}`, 'warning');
                }
                
                document.getElementById('controlPanel').style.display = 'block';
                document.getElementById('app').style.display = 'block';
                
                // 샘플 모델 코드 준비
                await prepareSampleModel();
                
            } catch (error) {
                console.error('WebR 초기화 오류:', error);
                logToConsole(`초기화 오류: ${error.message}`, 'error');
                statusDiv.className = 'status error';
                statusDiv.innerHTML = `
                    <h3>❌ 초기화 오류</h3>
                    <p>${error.message}</p>
                    <p><small>브라우저 콘솔에서 자세한 오류를 확인하세요.</small></p>
                `;
            }
        }
        
        // 샘플 모델 준비 (실제 모델 파일이 없을 경우를 대비)
        async function prepareSampleModel() {
            try {
                logToConsole('샘플 모델 준비 중...', 'info');
                
                // 간단한 PK/PD 모델 예제
                await webR.evalR(`
                    # Sepsis-AKI QSP 모델 샘플
                    # 이것은 간단한 데모 모델입니다
                    
                    # 모델 파라미터
                    params <- list(
                        # Cardio parameters
                        HR = 70,        # Heart rate
                        SV = 70,        # Stroke volume
                        TPR = 1,        # Total peripheral resistance
                        
                        # Renal parameters  
                        GFR = 120,      # Glomerular filtration rate
                        RBF = 1200,     # Renal blood flow
                        
                        # Immune parameters
                        TNF_alpha = 10, # TNF-alpha level
                        IL6 = 5,        # IL-6 level
                        IL10 = 2        # IL-10 level
                    )
                    
                    # 모델 함수 정의 (cardio_renal_model로 수정)
                    cardio_renal_model <- function(time, state, params) {
                        with(as.list(c(state, params)), {
                            # Cardiovascular dynamics
                            dBP <- (HR * SV / TPR) - BP
                            
                            # Renal function
                            dCreatinine <- (0.1 - GFR * Creatinine / 100)
                            
                            # Immune response
                            dCytokine <- TNF_alpha * 0.1 - Cytokine * 0.05
                            
                            return(list(c(dBP, dCreatinine, dCytokine)))
                        })
                    }
                    
                    # 초기 상태
                    initial_state <- c(
                        BP = 120,           # Blood pressure
                        Creatinine = 1.0,   # Serum creatinine
                        Cytokine = 10       # Cytokine level
                    )
                    
                    # 시간 벡터
                    times <- seq(0, 48, by = 0.5)  # 48시간 시뮬레이션
                    
                    print("모델 준비 완료!")
                    print("사용 가능한 변수: params, initial_state, times")
                    print("모델 함수: cardio_renal_model")
                `);
                
                logToConsole('샘플 모델 로드 완료!', 'info');
                document.getElementById('runSimBtn').disabled = false;
                modelLoaded = true;
                
            } catch (error) {
                logToConsole(`모델 준비 오류: ${error.message}`, 'error');
            }
        }
        
        // 모델 로드
        window.loadModel = async function() {
            if (!webR) {
                logToConsole('WebR이 초기화되지 않았습니다.', 'error');
                return;
            }
            
            try {
                logToConsole('모델 로드 시작...', 'info');
                document.getElementById('loadModelBtn').disabled = true;
                
                // 실제 모델 파일 로드 시도
                // 여기서는 샘플 모델을 다시 로드
                await prepareSampleModel();
                
                document.getElementById('loadModelBtn').disabled = false;
                
            } catch (error) {
                logToConsole(`모델 로드 오류: ${error.message}`, 'error');
                document.getElementById('loadModelBtn').disabled = false;
            }
        }
        
        // 시뮬레이션 실행
        window.runSimulation = async function() {
            if (!webR || !modelLoaded) {
                logToConsole('모델이 로드되지 않았습니다.', 'error');
                return;
            }
            
            try {
                logToConsole('시뮬레이션 실행 중...', 'info');
                document.getElementById('runSimBtn').disabled = true;
                
                // ODE 솔버 없이 간단한 시뮬레이션
                const result = await webR.evalR(`
                    # 간단한 시뮬레이션 (ODE 솔버 없이)
                    simulation_results <- data.frame(
                        time = times,
                        BP = 120 * exp(-times/20) + 80,
                        Creatinine = 1.0 + 0.5 * (1 - exp(-times/10)),
                        Cytokine = 10 * exp(-times/15)
                    )
                    
                    # 결과 요약
                    print("시뮬레이션 완료!")
                    print(paste("시뮬레이션 시간:", max(times), "hours"))
                    print(paste("최종 BP:", round(tail(simulation_results$BP, 1), 2)))
                    print(paste("최종 Creatinine:", round(tail(simulation_results$Creatinine, 1), 3)))
                    print(paste("최종 Cytokine:", round(tail(simulation_results$Cytokine, 1), 2)))
                    
                    # JSON으로 변환하여 JavaScript로 전달
                    jsonlite::toJSON(simulation_results)
                `);
                
                // 결과를 JavaScript로 가져오기 (간단한 시각화를 위해)
                await plotResults();
                
                logToConsole('시뮬레이션 완료!', 'info');
                document.getElementById('runSimBtn').disabled = false;
                
            } catch (error) {
                logToConsole(`시뮬레이션 오류: ${error.message}`, 'error');
                document.getElementById('runSimBtn').disabled = false;
            }
        }
        
        // 결과 플로팅
        async function plotResults() {
            try {
                // 샘플 데이터로 플롯 생성
                const times = Array.from({length: 97}, (_, i) => i * 0.5);
                
                const trace1 = {
                    x: times,
                    y: times.map(t => 120 * Math.exp(-t/20) + 80),
                    mode: 'lines',
                    name: 'Blood Pressure (mmHg)',
                    line: {color: 'red'}
                };
                
                const trace2 = {
                    x: times,
                    y: times.map(t => 1.0 + 0.5 * (1 - Math.exp(-t/10))),
                    mode: 'lines',
                    name: 'Creatinine (mg/dL)',
                    line: {color: 'blue'},
                    yaxis: 'y2'
                };
                
                const trace3 = {
                    x: times,
                    y: times.map(t => 10 * Math.exp(-t/15)),
                    mode: 'lines',
                    name: 'Cytokine Level',
                    line: {color: 'green'},
                    yaxis: 'y3'
                };
                
                const layout = {
                    title: 'Sepsis-AKI Model Simulation Results',
                    xaxis: {title: 'Time (hours)'},
                    yaxis: {
                        title: 'Blood Pressure (mmHg)',
                        titlefont: {color: 'red'},
                        tickfont: {color: 'red'}
                    },
                    yaxis2: {
                        title: 'Creatinine (mg/dL)',
                        titlefont: {color: 'blue'},
                        tickfont: {color: 'blue'},
                        overlaying: 'y',
                        side: 'right'
                    },
                    yaxis3: {
                        title: 'Cytokine Level',
                        titlefont: {color: 'green'},
                        tickfont: {color: 'green'},
                        overlaying: 'y',
                        side: 'right',
                        anchor: 'free',
                        position: 0.85
                    }
                };
                
                Plotly.newPlot('plotArea', [trace1, trace2, trace3], layout);
                logToConsole('플롯 생성 완료!', 'info');
                
            } catch (error) {
                logToConsole(`플롯 생성 오류: ${error.message}`, 'error');
            }
        }
        
        // 페이지 로드 시 실행
        window.addEventListener('load', async () => {
            await checkFiles();
            await initWebR();
        });
    </script>
</body>
</html>
