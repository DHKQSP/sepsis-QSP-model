<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sepsis-AKI QSP Model</title>
    <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            margin: 0;
        }
        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e9ecef;
        }
        .status {
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
        .success {
            background: #d4edda;
            color: #155724;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
        }
        .loading {
            background: #d1ecf1;
            color: #0c5460;
        }
        .warning {
            background: #fff3cd;
            color: #856404;
        }
        .file-list {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
        }
        .file-list h3 {
            margin-top: 0;
        }
        .file-list ul {
            list-style: none;
            padding: 0;
        }
        .file-list li {
            padding: 5px 0;
        }
        .file-list .found {
            color: green;
        }
        .file-list .missing {
            color: red;
        }
        .console {
            background: #1e1e1e;
            color: #00ff00;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            max-height: 300px;
            overflow-y: auto;
            margin: 20px 0;
        }
        .control-panel {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        .plot-container {
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¥ Sepsis-AKI QSP Model</h1>
            <p>Cardio-Renal-Immune Systems Pharmacology Simulator</p>
        </div>
        
        <div id="status" class="status loading">
            <h3>ğŸ“Š ì‹œìŠ¤í…œ ìƒíƒœ</h3>
            <p>WebR ì´ˆê¸°í™” ì¤€ë¹„ ì¤‘...</p>
        </div>
        
        <div class="file-list">
            <h3>ğŸ“ ëª¨ë¸ íŒŒì¼ ìƒíƒœ</h3>
            <ul id="fileStatus">
                <li>í™•ì¸ ì¤‘...</li>
            </ul>
        </div>
        
        <div class="control-panel" id="controlPanel" style="display:none;">
            <h3>ğŸ›ï¸ ëª¨ë¸ ì œì–´</h3>
            <button id="loadModelBtn" onclick="loadModel()">ëª¨ë¸ ë¡œë“œ</button>
            <button id="runSimBtn" onclick="runSimulation()" disabled>ì‹œë®¬ë ˆì´ì…˜ ì‹¤í–‰</button>
            <button id="clearConsoleBtn" onclick="clearConsole()">ì½˜ì†” í´ë¦¬ì–´</button>
        </div>
        
        <div class="console" id="console" style="display:none;">
            <div id="consoleOutput">Console output will appear here...</div>
        </div>
        
        <div id="app" style="display:none;">
            <div class="plot-container">
                <h3>ğŸ“ˆ ì‹œë®¬ë ˆì´ì…˜ ê²°ê³¼</h3>
                <div id="plotArea"></div>
            </div>
        </div>
    </div>
    
    <script type="module">
        let webR = null;
        let modelLoaded = false;
        
        // ì½˜ì†” ì¶œë ¥ í•¨ìˆ˜
        function logToConsole(message, type = 'info') {
            const consoleDiv = document.getElementById('console');
            const consoleOutput = document.getElementById('consoleOutput');
            consoleDiv.style.display = 'block';
            
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? '#ff6b6b' : type === 'warning' ? '#ffd93d' : '#00ff00';
            consoleOutput.innerHTML += `<div style="color: ${color}">[${timestamp}] ${message}</div>`;
            consoleOutput.scrollTop = consoleOutput.scrollHeight;
        }
        
        // ì½˜ì†” í´ë¦¬ì–´
        window.clearConsole = function() {
            document.getElementById('consoleOutput').innerHTML = 'Console cleared.<br>';
        }
        
        // íŒŒì¼ ì¡´ì¬ í™•ì¸
        async function checkFiles() {
            const files = [
                'modelfile_0822.R',
                'calcNomParams_human_0602.R',
                'runmodel.R'
            ];
            
            const fileStatus = document.getElementById('fileStatus');
            fileStatus.innerHTML = '';
            
            for (const file of files) {
                const li = document.createElement('li');
                li.className = 'warning';
                li.innerHTML = `âš ï¸ ${file} - ë¡œì»¬ íŒŒì¼ (WebRì—ì„œ ì§ì ‘ ë¡œë“œ ë¶ˆê°€)`;
                fileStatus.appendChild(li);
            }
            
            const note = document.createElement('li');
            note.innerHTML = `<br>ğŸ“ ì°¸ê³ : ìƒ˜í”Œ ëª¨ë¸ì„ ì‚¬ìš©í•˜ì—¬ ì‹œë®¬ë ˆì´ì…˜ì„ ì‹¤í–‰í•©ë‹ˆë‹¤.`;
            fileStatus.appendChild(note);
        }
        
        // WebR ì´ˆê¸°í™”
        async function initWebR() {
            const statusDiv = document.getElementById('status');
            
            try {
                logToConsole('WebR ì´ˆê¸°í™” ì‹œì‘...', 'info');
                
                // WebR import
                const { WebR } = await import('https://webr.r-wasm.org/latest/webr.mjs');
                
                statusDiv.innerHTML = '<h3>ğŸ“Š ì‹œìŠ¤í…œ ìƒíƒœ</h3><p>WebR ë¡œë”© ì¤‘... (1-2ë¶„ ì†Œìš”)</p>';
                statusDiv.className = 'status loading';
                
                // WebR ì¸ìŠ¤í„´ìŠ¤ ìƒì„±
                webR = new WebR({
                    channelType: 'PostMessage'
                });
                
                await webR.init();
                logToConsole('WebR ì´ˆê¸°í™” ì™„ë£Œ!', 'info');
                
                // ê¸°ë³¸ R í™˜ê²½ ì„¤ì •
                await webR.evalR(`
                    # ê¸°ë³¸ ì„¤ì •
                    options(warn = -1)
                    
                    # ì‘ì—… ë””ë ‰í† ë¦¬ í™•ì¸
                    print(paste("Working directory:", getwd()))
                    print("WebR í™˜ê²½ ì¤€ë¹„ ì™„ë£Œ!")
                    print(paste("R version:", R.version.string))
                `);
                
                statusDiv.className = 'status success';
                statusDiv.innerHTML = '<h3>âœ… ì‹œìŠ¤í…œ ì¤€ë¹„ ì™„ë£Œ</h3><p>WebRì´ ì„±ê³µì ìœ¼ë¡œ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.</p>';
                
                document.getElementById('controlPanel').style.display = 'block';
                document.getElementById('app').style.display = 'block';
                
                // ìƒ˜í”Œ ëª¨ë¸ ì¤€ë¹„
                await prepareSampleModel();
                
            } catch (error) {
                console.error('WebR ì´ˆê¸°í™” ì˜¤ë¥˜:', error);
                logToConsole(`ì´ˆê¸°í™” ì˜¤ë¥˜: ${error.message}`, 'error');
                statusDiv.className = 'status error';
                statusDiv.innerHTML = `
                    <h3>âŒ ì´ˆê¸°í™” ì˜¤ë¥˜</h3>
                    <p>${error.message}</p>
                    <p><small>ë¸Œë¼ìš°ì € ì½˜ì†”ì—ì„œ ìì„¸í•œ ì˜¤ë¥˜ë¥¼ í™•ì¸í•˜ì„¸ìš”.</small></p>
                `;
            }
        }
        
        // ìƒ˜í”Œ ëª¨ë¸ ì¤€ë¹„
        async function prepareSampleModel() {
            try {
                logToConsole('ìƒ˜í”Œ ëª¨ë¸ ì¤€ë¹„ ì¤‘...', 'info');
                
                await webR.evalR(`
                    # Sepsis-AKI QSP ëª¨ë¸ (ê°„ì†Œí™” ë²„ì „)
                    
                    # ëª¨ë¸ íŒŒë¼ë¯¸í„°
                    params <- list(
                        # Cardiovascular parameters
                        HR_base = 70,      # Baseline heart rate (bpm)
                        SV_base = 70,      # Baseline stroke volume (mL)
                        TPR_base = 1,      # Baseline total peripheral resistance
                        
                        # Renal parameters  
                        GFR_base = 120,    # Baseline GFR (mL/min)
                        RBF_base = 1200,   # Baseline renal blood flow (mL/min)
                        
                        # Immune parameters
                        TNF_prod = 0.5,    # TNF-alpha production rate
                        TNF_clear = 0.1,   # TNF-alpha clearance rate
                        IL6_prod = 0.3,    # IL-6 production rate
                        IL6_clear = 0.08,  # IL-6 clearance rate
                        
                        # Sepsis severity (0-1)
                        sepsis_severity = 0.5
                    )
                    
                    # ì´ˆê¸° ìƒíƒœ
                    initial_state <- c(
                        MAP = 90,          # Mean arterial pressure (mmHg)
                        HR = 70,           # Heart rate (bpm)
                        Creatinine = 1.0,  # Serum creatinine (mg/dL)
                        TNF = 10,          # TNF-alpha (pg/mL)
                        IL6 = 5,           # IL-6 (pg/mL)
                        Fluid = 0          # Fluid balance (L)
                    )
                    
                    # ì‹œê°„ ë²¡í„° (72ì‹œê°„)
                    times <- seq(0, 72, by = 1)
                    
                    print("ëª¨ë¸ ì¤€ë¹„ ì™„ë£Œ!")
                    print(paste("íŒŒë¼ë¯¸í„° ê°œìˆ˜:", length(params)))
                    print(paste("ìƒíƒœ ë³€ìˆ˜ ê°œìˆ˜:", length(initial_state)))
                    print(paste("ì‹œë®¬ë ˆì´ì…˜ ì‹œê°„: 0 -", max(times), "hours"))
                `);
                
                logToConsole('ìƒ˜í”Œ ëª¨ë¸ ë¡œë“œ ì™„ë£Œ!', 'info');
                document.getElementById('runSimBtn').disabled = false;
                modelLoaded = true;
                
            } catch (error) {
                logToConsole(`ëª¨ë¸ ì¤€ë¹„ ì˜¤ë¥˜: ${error.message}`, 'error');
            }
        }
        
        // ëª¨ë¸ ë¡œë“œ
        window.loadModel = async function() {
            if (!webR) {
                logToConsole('WebRì´ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.', 'error');
                return;
            }
            
            try {
                logToConsole('ëª¨ë¸ ì¬ë¡œë“œ ì¤‘...', 'info');
                document.getElementById('loadModelBtn').disabled = true;
                
                await prepareSampleModel();
                
                document.getElementById('loadModelBtn').disabled = false;
                
            } catch (error) {
                logToConsole(`ëª¨ë¸ ë¡œë“œ ì˜¤ë¥˜: ${error.message}`, 'error');
                document.getElementById('loadModelBtn').disabled = false;
            }
        }
        
        // ì‹œë®¬ë ˆì´ì…˜ ì‹¤í–‰
        window.runSimulation = async function() {
            if (!webR || !modelLoaded) {
                logToConsole('ëª¨ë¸ì´ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.', 'error');
                return;
            }
            
            try {
                logToConsole('ì‹œë®¬ë ˆì´ì…˜ ì‹¤í–‰ ì¤‘...', 'info');
                document.getElementById('runSimBtn').disabled = true;
                
                // ì‹œë®¬ë ˆì´ì…˜ ì‹¤í–‰ (ODE ì†”ë²„ ì—†ì´)
                await webR.evalR(`
                    # ê°„ë‹¨í•œ ì‹œë®¬ë ˆì´ì…˜ ë¡œì§
                    n_times <- length(times)
                    
                    # ê²°ê³¼ ì €ì¥ìš© í–‰ë ¬
                    results <- matrix(0, nrow = n_times, ncol = 6)
                    colnames(results) <- names(initial_state)
                    
                    # ì´ˆê¸°ê°’ ì„¤ì •
                    results[1, ] <- initial_state
                    
                    # ì‹œë®¬ë ˆì´ì…˜ ë£¨í”„
                    for (i in 2:n_times) {
                        t <- times[i]
                        dt <- times[i] - times[i-1]
                        
                        # Sepsis progression
                        sepsis_factor <- 1 + params$sepsis_severity * (1 - exp(-t/24))
                        
                        # Cardiovascular response
                        results[i, "HR"] <- params$HR_base * (1 + 0.3 * sepsis_factor)
                        results[i, "MAP"] <- 90 - 20 * sepsis_factor + 10 * sin(t/6)
                        
                        # Renal function deterioration
                        results[i, "Creatinine"] <- initial_state["Creatinine"] * 
                            (1 + params$sepsis_severity * (1 - exp(-t/36)))
                        
                        # Cytokine dynamics
                        results[i, "TNF"] <- initial_state["TNF"] * 
                            exp(-params$TNF_clear * t) + 
                            params$TNF_prod * sepsis_factor * 50
                        
                        results[i, "IL6"] <- initial_state["IL6"] * 
                            exp(-params$IL6_clear * t) + 
                            params$IL6_prod * sepsis_factor * 30
                        
                        # Fluid balance
                        results[i, "Fluid"] <- 2 * sin(t/12) + t * 0.05
                    }
                    
                    # ê²°ê³¼ë¥¼ ë°ì´í„°í”„ë ˆì„ìœ¼ë¡œ ë³€í™˜
                    simulation_results <- as.data.frame(cbind(time = times, results))
                    
                    # ê²°ê³¼ ìš”ì•½ ì¶œë ¥
                    print("========== ì‹œë®¬ë ˆì´ì…˜ ì™„ë£Œ ==========")
                    print(paste("ì‹œë®¬ë ˆì´ì…˜ ì‹œê°„:", max(times), "hours"))
                    print("")
                    print("ìµœì¢… ê°’:")
                    print(paste("  MAP:", round(tail(simulation_results$MAP, 1), 1), "mmHg"))
                    print(paste("  Heart Rate:", round(tail(simulation_results$HR, 1), 0), "bpm"))
                    print(paste("  Creatinine:", round(tail(simulation_results$Creatinine, 1), 2), "mg/dL"))
                    print(paste("  TNF-alpha:", round(tail(simulation_results$TNF, 1), 1), "pg/mL"))
                    print(paste("  IL-6:", round(tail(simulation_results$IL6, 1), 1), "pg/mL"))
                    print(paste("  Fluid Balance:", round(tail(simulation_results$Fluid, 1), 2), "L"))
                    print("=====================================")
                `);
                
                // WebRì—ì„œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
                const timeData = await webR.evalR('times');
                const mapData = await webR.evalR('simulation_results$MAP');
                const hrData = await webR.evalR('simulation_results$HR');
                const creatData = await webR.evalR('simulation_results$Creatinine');
                const tnfData = await webR.evalR('simulation_results$TNF');
                const il6Data = await webR.evalR('simulation_results$IL6');
                
                // JavaScript ë°°ì—´ë¡œ ë³€í™˜
                const times = await timeData.toArray();
                const map = await mapData.toArray();
                const hr = await hrData.toArray();
                const creatinine = await creatData.toArray();
                const tnf = await tnfData.toArray();
                const il6 = await il6Data.toArray();
                
                // í”Œë¡¯ ìƒì„±
                await plotResults(times, map, hr, creatinine, tnf, il6);
                
                logToConsole('ì‹œë®¬ë ˆì´ì…˜ ì™„ë£Œ!', 'info');
                document.getElementById('runSimBtn').disabled = false;
                
            } catch (error) {
                logToConsole(`ì‹œë®¬ë ˆì´ì…˜ ì˜¤ë¥˜: ${error.message}`, 'error');
                document.getElementById('runSimBtn').disabled = false;
            }
        }
        
        // ê²°ê³¼ í”Œë¡œíŒ…
        async function plotResults(times, map, hr, creatinine, tnf, il6) {
            try {
                // Subplot 1: Cardiovascular
                const trace1 = {
                    x: times,
                    y: map,
                    mode: 'lines',
                    name: 'MAP (mmHg)',
                    line: {color: 'red', width: 2}
                };
                
                const trace2 = {
                    x: times,
                    y: hr,
                    mode: 'lines',
                    name: 'Heart Rate (bpm)',
                    line: {color: 'orange', width: 2},
                    yaxis: 'y2'
                };
                
                // Subplot 2: Renal
                const trace3 = {
                    x: times,
                    y: creatinine,
                    mode: 'lines',
                    name: 'Creatinine (mg/dL)',
                    line: {color: 'blue', width: 2},
                    xaxis: 'x2',
                    yaxis: 'y3'
                };
                
                // Subplot 3: Immune
                const trace4 = {
                    x: times,
                    y: tnf,
                    mode: 'lines',
                    name: 'TNF-Î± (pg/mL)',
                    line: {color: 'green', width: 2},
                    xaxis: 'x3',
                    yaxis: 'y4'
                };
                
                const trace5 = {
                    x: times,
                    y: il6,
                    mode: 'lines',
                    name: 'IL-6 (pg/mL)',
                    line: {color: 'purple', width: 2},
                    xaxis: 'x3',
                    yaxis: 'y5'
                };
                
                const layout = {
                    title: 'Sepsis-AKI Model Simulation Results',
                    grid: {rows: 3, columns: 1, pattern: 'independent'},
                    height: 800,
                    
                    xaxis: {
                        title: 'Time (hours)',
                        domain: [0, 1]
                    },
                    yaxis: {
                        title: 'MAP (mmHg)',
                        titlefont: {color: 'red'},
                        tickfont: {color: 'red'},
                        domain: [0.7, 1]
                    },
                    yaxis2: {
                        title: 'Heart Rate (bpm)',
                        titlefont: {color: 'orange'},
                        tickfont: {color: 'orange'},
                        overlaying: 'y',
                        side: 'right'
                    },
                    
                    xaxis2: {
                        title: 'Time (hours)',
                        domain: [0, 1],
                        anchor: 'y3'
                    },
                    yaxis3: {
                        title: 'Creatinine (mg/dL)',
                        titlefont: {color: 'blue'},
                        tickfont: {color: 'blue'},
                        domain: [0.35, 0.65]
                    },
                    
                    xaxis3: {
                        title: 'Time (hours)',
                        domain: [0, 1],
                        anchor: 'y4'
                    },
                    yaxis4: {
                        title: 'TNF-Î± (pg/mL)',
                        titlefont: {color: 'green'},
                        tickfont: {color: 'green'},
                        domain: [0, 0.3]
                    },
                    yaxis5: {
                        title: 'IL-6 (pg/mL)',
                        titlefont: {color: 'purple'},
                        tickfont: {color: 'purple'},
                        overlaying: 'y4',
                        side: 'right',
                        anchor: 'x3'
                    }
                };
                
                Plotly.newPlot('plotArea', [trace1, trace2, trace3, trace4, trace5], layout);
                logToConsole('í”Œë¡¯ ìƒì„± ì™„ë£Œ!', 'info');
                
            } catch (error) {
                logToConsole(`í”Œë¡¯ ìƒì„± ì˜¤ë¥˜: ${error.message}`, 'error');
            }
        }
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
        window.addEventListener('load', async () => {
            await checkFiles();
            await initWebR();
        });
    </script>
</body>
</html>
