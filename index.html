<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sepsis-AKI QSP Model</title>
    <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            margin: 0;
        }
        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e9ecef;
        }
        .status {
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
        .success {
            background: #d4edda;
            color: #155724;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
        }
        .loading {
            background: #d1ecf1;
            color: #0c5460;
        }
        .warning {
            background: #fff3cd;
            color: #856404;
        }
        .file-list {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
        }
        .file-list h3 {
            margin-top: 0;
        }
        .file-list ul {
            list-style: none;
            padding: 0;
        }
        .file-list li {
            padding: 5px 0;
        }
        .file-list .found {
            color: green;
        }
        .file-list .missing {
            color: red;
        }
        .console {
            background: #1e1e1e;
            color: #00ff00;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            max-height: 300px;
            overflow-y: auto;
            margin: 20px 0;
        }
        .control-panel {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        .plot-container {
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🏥 Sepsis-AKI QSP Model</h1>
            <p>Cardio-Renal-Immune Systems Pharmacology Simulator</p>
        </div>
        
        <div id="status" class="status loading">
            <h3>📊 시스템 상태</h3>
            <p>WebR 초기화 준비 중...</p>
        </div>
        
        <div class="file-list">
            <h3>📁 모델 파일 상태</h3>
            <ul id="fileStatus">
                <li>확인 중...</li>
            </ul>
        </div>
        
        <div class="control-panel" id="controlPanel" style="display:none;">
            <h3>🎛️ 모델 제어</h3>
            <button id="loadModelBtn" onclick="loadModel()">모델 로드</button>
            <button id="runSimBtn" onclick="runSimulation()" disabled>시뮬레이션 실행</button>
            <button id="clearConsoleBtn" onclick="clearConsole()">콘솔 클리어</button>
        </div>
        
        <div class="console" id="console" style="display:none;">
            <div id="consoleOutput">Console output will appear here...</div>
        </div>
        
        <div id="app" style="display:none;">
            <div class="plot-container">
                <h3>📈 시뮬레이션 결과</h3>
                <div id="plotArea"></div>
            </div>
        </div>
    </div>
    
    <script type="module">
        let webR = null;
        let modelLoaded = false;
        
        // 콘솔 출력 함수
        function logToConsole(message, type = 'info') {
            const consoleDiv = document.getElementById('console');
            const consoleOutput = document.getElementById('consoleOutput');
            consoleDiv.style.display = 'block';
            
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? '#ff6b6b' : type === 'warning' ? '#ffd93d' : '#00ff00';
            consoleOutput.innerHTML += `<div style="color: ${color}">[${timestamp}] ${message}</div>`;
            consoleOutput.scrollTop = consoleOutput.scrollHeight;
        }
        
        // 콘솔 클리어
        window.clearConsole = function() {
            document.getElementById('consoleOutput').innerHTML = 'Console cleared.<br>';
        }
        
        // 파일 존재 확인
        async function checkFiles() {
            const files = [
                'modelfile_0822.R',
                'calcNomParams_human_0602.R',
                'runmodel.R'
            ];
            
            const fileStatus = document.getElementById('fileStatus');
            fileStatus.innerHTML = '';
            
            for (const file of files) {
                const li = document.createElement('li');
                li.className = 'warning';
                li.innerHTML = `⚠️ ${file} - 로컬 파일 (WebR에서 직접 로드 불가)`;
                fileStatus.appendChild(li);
            }
            
            const note = document.createElement('li');
            note.innerHTML = `<br>📝 참고: 샘플 모델을 사용하여 시뮬레이션을 실행합니다.`;
            fileStatus.appendChild(note);
        }
        
        // WebR 초기화
        async function initWebR() {
            const statusDiv = document.getElementById('status');
            
            try {
                logToConsole('WebR 초기화 시작...', 'info');
                
                // WebR import
                const { WebR } = await import('https://webr.r-wasm.org/latest/webr.mjs');
                
                statusDiv.innerHTML = '<h3>📊 시스템 상태</h3><p>WebR 로딩 중... (1-2분 소요)</p>';
                statusDiv.className = 'status loading';
                
                // WebR 인스턴스 생성
                webR = new WebR({
                    channelType: 'PostMessage'
                });
                
                await webR.init();
                logToConsole('WebR 초기화 완료!', 'info');
                
                // 기본 R 환경 설정
                await webR.evalR(`
                    # 기본 설정
                    options(warn = -1)
                    
                    # 작업 디렉토리 확인
                    print(paste("Working directory:", getwd()))
                    print("WebR 환경 준비 완료!")
                    print(paste("R version:", R.version.string))
                `);
                
                statusDiv.className = 'status success';
                statusDiv.innerHTML = '<h3>✅ 시스템 준비 완료</h3><p>WebR이 성공적으로 초기화되었습니다.</p>';
                
                document.getElementById('controlPanel').style.display = 'block';
                document.getElementById('app').style.display = 'block';
                
                // 샘플 모델 준비
                await prepareSampleModel();
                
            } catch (error) {
                console.error('WebR 초기화 오류:', error);
                logToConsole(`초기화 오류: ${error.message}`, 'error');
                statusDiv.className = 'status error';
                statusDiv.innerHTML = `
                    <h3>❌ 초기화 오류</h3>
                    <p>${error.message}</p>
                    <p><small>브라우저 콘솔에서 자세한 오류를 확인하세요.</small></p>
                `;
            }
        }
        
        // 샘플 모델 준비
        async function prepareSampleModel() {
            try {
                logToConsole('샘플 모델 준비 중...', 'info');
                
                await webR.evalR(`
                    # Sepsis-AKI QSP 모델 (간소화 버전)
                    
                    # 모델 파라미터
                    params <- list(
                        # Cardiovascular parameters
                        HR_base = 70,      # Baseline heart rate (bpm)
                        SV_base = 70,      # Baseline stroke volume (mL)
                        TPR_base = 1,      # Baseline total peripheral resistance
                        
                        # Renal parameters  
                        GFR_base = 120,    # Baseline GFR (mL/min)
                        RBF_base = 1200,   # Baseline renal blood flow (mL/min)
                        
                        # Immune parameters
                        TNF_prod = 0.5,    # TNF-alpha production rate
                        TNF_clear = 0.1,   # TNF-alpha clearance rate
                        IL6_prod = 0.3,    # IL-6 production rate
                        IL6_clear = 0.08,  # IL-6 clearance rate
                        
                        # Sepsis severity (0-1)
                        sepsis_severity = 0.5
                    )
                    
                    # 초기 상태
                    initial_state <- c(
                        MAP = 90,          # Mean arterial pressure (mmHg)
                        HR = 70,           # Heart rate (bpm)
                        Creatinine = 1.0,  # Serum creatinine (mg/dL)
                        TNF = 10,          # TNF-alpha (pg/mL)
                        IL6 = 5,           # IL-6 (pg/mL)
                        Fluid = 0          # Fluid balance (L)
                    )
                    
                    # 시간 벡터 (72시간)
                    times <- seq(0, 72, by = 1)
                    
                    print("모델 준비 완료!")
                    print(paste("파라미터 개수:", length(params)))
                    print(paste("상태 변수 개수:", length(initial_state)))
                    print(paste("시뮬레이션 시간: 0 -", max(times), "hours"))
                `);
                
                logToConsole('샘플 모델 로드 완료!', 'info');
                document.getElementById('runSimBtn').disabled = false;
                modelLoaded = true;
                
            } catch (error) {
                logToConsole(`모델 준비 오류: ${error.message}`, 'error');
            }
        }
        
        // 모델 로드
        window.loadModel = async function() {
            if (!webR) {
                logToConsole('WebR이 초기화되지 않았습니다.', 'error');
                return;
            }
            
            try {
                logToConsole('모델 재로드 중...', 'info');
                document.getElementById('loadModelBtn').disabled = true;
                
                await prepareSampleModel();
                
                document.getElementById('loadModelBtn').disabled = false;
                
            } catch (error) {
                logToConsole(`모델 로드 오류: ${error.message}`, 'error');
                document.getElementById('loadModelBtn').disabled = false;
            }
        }
        
        // 시뮬레이션 실행
        window.runSimulation = async function() {
            if (!webR || !modelLoaded) {
                logToConsole('모델이 로드되지 않았습니다.', 'error');
                return;
            }
            
            try {
                logToConsole('시뮬레이션 실행 중...', 'info');
                document.getElementById('runSimBtn').disabled = true;
                
                // 시뮬레이션 실행 (ODE 솔버 없이)
                await webR.evalR(`
                    # 간단한 시뮬레이션 로직
                    n_times <- length(times)
                    
                    # 결과 저장용 행렬
                    results <- matrix(0, nrow = n_times, ncol = 6)
                    colnames(results) <- names(initial_state)
                    
                    # 초기값 설정
                    results[1, ] <- initial_state
                    
                    # 시뮬레이션 루프
                    for (i in 2:n_times) {
                        t <- times[i]
                        dt <- times[i] - times[i-1]
                        
                        # Sepsis progression
                        sepsis_factor <- 1 + params$sepsis_severity * (1 - exp(-t/24))
                        
                        # Cardiovascular response
                        results[i, "HR"] <- params$HR_base * (1 + 0.3 * sepsis_factor)
                        results[i, "MAP"] <- 90 - 20 * sepsis_factor + 10 * sin(t/6)
                        
                        # Renal function deterioration
                        results[i, "Creatinine"] <- initial_state["Creatinine"] * 
                            (1 + params$sepsis_severity * (1 - exp(-t/36)))
                        
                        # Cytokine dynamics
                        results[i, "TNF"] <- initial_state["TNF"] * 
                            exp(-params$TNF_clear * t) + 
                            params$TNF_prod * sepsis_factor * 50
                        
                        results[i, "IL6"] <- initial_state["IL6"] * 
                            exp(-params$IL6_clear * t) + 
                            params$IL6_prod * sepsis_factor * 30
                        
                        # Fluid balance
                        results[i, "Fluid"] <- 2 * sin(t/12) + t * 0.05
                    }
                    
                    # 결과를 데이터프레임으로 변환
                    simulation_results <- as.data.frame(cbind(time = times, results))
                    
                    # 결과 요약 출력
                    print("========== 시뮬레이션 완료 ==========")
                    print(paste("시뮬레이션 시간:", max(times), "hours"))
                    print("")
                    print("최종 값:")
                    print(paste("  MAP:", round(tail(simulation_results$MAP, 1), 1), "mmHg"))
                    print(paste("  Heart Rate:", round(tail(simulation_results$HR, 1), 0), "bpm"))
                    print(paste("  Creatinine:", round(tail(simulation_results$Creatinine, 1), 2), "mg/dL"))
                    print(paste("  TNF-alpha:", round(tail(simulation_results$TNF, 1), 1), "pg/mL"))
                    print(paste("  IL-6:", round(tail(simulation_results$IL6, 1), 1), "pg/mL"))
                    print(paste("  Fluid Balance:", round(tail(simulation_results$Fluid, 1), 2), "L"))
                    print("=====================================")
                `);
                
                // WebR에서 데이터 가져오기
                const timeData = await webR.evalR('times');
                const mapData = await webR.evalR('simulation_results$MAP');
                const hrData = await webR.evalR('simulation_results$HR');
                const creatData = await webR.evalR('simulation_results$Creatinine');
                const tnfData = await webR.evalR('simulation_results$TNF');
                const il6Data = await webR.evalR('simulation_results$IL6');
                
                // JavaScript 배열로 변환
                const times = await timeData.toArray();
                const map = await mapData.toArray();
                const hr = await hrData.toArray();
                const creatinine = await creatData.toArray();
                const tnf = await tnfData.toArray();
                const il6 = await il6Data.toArray();
                
                // 플롯 생성
                await plotResults(times, map, hr, creatinine, tnf, il6);
                
                logToConsole('시뮬레이션 완료!', 'info');
                document.getElementById('runSimBtn').disabled = false;
                
            } catch (error) {
                logToConsole(`시뮬레이션 오류: ${error.message}`, 'error');
                document.getElementById('runSimBtn').disabled = false;
            }
        }
        
        // 결과 플로팅
        async function plotResults(times, map, hr, creatinine, tnf, il6) {
            try {
                // Subplot 1: Cardiovascular
                const trace1 = {
                    x: times,
                    y: map,
                    mode: 'lines',
                    name: 'MAP (mmHg)',
                    line: {color: 'red', width: 2}
                };
                
                const trace2 = {
                    x: times,
                    y: hr,
                    mode: 'lines',
                    name: 'Heart Rate (bpm)',
                    line: {color: 'orange', width: 2},
                    yaxis: 'y2'
                };
                
                // Subplot 2: Renal
                const trace3 = {
                    x: times,
                    y: creatinine,
                    mode: 'lines',
                    name: 'Creatinine (mg/dL)',
                    line: {color: 'blue', width: 2},
                    xaxis: 'x2',
                    yaxis: 'y3'
                };
                
                // Subplot 3: Immune
                const trace4 = {
                    x: times,
                    y: tnf,
                    mode: 'lines',
                    name: 'TNF-α (pg/mL)',
                    line: {color: 'green', width: 2},
                    xaxis: 'x3',
                    yaxis: 'y4'
                };
                
                const trace5 = {
                    x: times,
                    y: il6,
                    mode: 'lines',
                    name: 'IL-6 (pg/mL)',
                    line: {color: 'purple', width: 2},
                    xaxis: 'x3',
                    yaxis: 'y5'
                };
                
                const layout = {
                    title: 'Sepsis-AKI Model Simulation Results',
                    grid: {rows: 3, columns: 1, pattern: 'independent'},
                    height: 800,
                    
                    xaxis: {
                        title: 'Time (hours)',
                        domain: [0, 1]
                    },
                    yaxis: {
                        title: 'MAP (mmHg)',
                        titlefont: {color: 'red'},
                        tickfont: {color: 'red'},
                        domain: [0.7, 1]
                    },
                    yaxis2: {
                        title: 'Heart Rate (bpm)',
                        titlefont: {color: 'orange'},
                        tickfont: {color: 'orange'},
                        overlaying: 'y',
                        side: 'right'
                    },
                    
                    xaxis2: {
                        title: 'Time (hours)',
                        domain: [0, 1],
                        anchor: 'y3'
                    },
                    yaxis3: {
                        title: 'Creatinine (mg/dL)',
                        titlefont: {color: 'blue'},
                        tickfont: {color: 'blue'},
                        domain: [0.35, 0.65]
                    },
                    
                    xaxis3: {
                        title: 'Time (hours)',
                        domain: [0, 1],
                        anchor: 'y4'
                    },
                    yaxis4: {
                        title: 'TNF-α (pg/mL)',
                        titlefont: {color: 'green'},
                        tickfont: {color: 'green'},
                        domain: [0, 0.3]
                    },
                    yaxis5: {
                        title: 'IL-6 (pg/mL)',
                        titlefont: {color: 'purple'},
                        tickfont: {color: 'purple'},
                        overlaying: 'y4',
                        side: 'right',
                        anchor: 'x3'
                    }
                };
                
                Plotly.newPlot('plotArea', [trace1, trace2, trace3, trace4, trace5], layout);
                logToConsole('플롯 생성 완료!', 'info');
                
            } catch (error) {
                logToConsole(`플롯 생성 오류: ${error.message}`, 'error');
            }
        }
        
        // 페이지 로드 시 실행
        window.addEventListener('load', async () => {
            await checkFiles();
            await initWebR();
        });
    </script>
</body>
</html>
