<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Sepsis-AKI Full QSP Model</title>
    <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
    <style>
        /* 이전 스타일 유지 */
    </style>
</head>
<body>
    <div class="container">
        <!-- UI는 이전과 동일 -->
    </div>
    
    <script type="module">
        import { WebR } from 'https://webr.r-wasm.org/latest/webr.mjs';
        
        let webR;
        let modelLoaded = false;
        
        async function initializeModel() {
            console.log('WebR 초기화 중...');
            webR = new WebR();
            await webR.init();
            
            // 전체 모델 파일을 문자열로 포함
            const modelCode = `
                # modelfile_0822.R 전체 내용
                ${await fetch('modelfile_0822.R').then(r => r.text())}
            `;
            
            const paramsCode = `
                # calcNomParams_human_0602.R 전체 내용
                ${await fetch('calcNomParams_human_0602.R').then(r => r.text())}
            `;
            
            // WebR용 rxode2 설치
            await webR.evalR(`
                # WebR 패키지 설치
                webr::install("rxode2")
                library(rxode2)
                
                # 모델 구조 정의
                ${modelCode}
                
                # 파라미터 함수 정의
                ${paramsCode}
                
                # 모델 컴파일
                m1 <- rxode2(model = ode)
                theta <- calcNomParams()
                
                print("모델 로드 완료!")
            `);
            
            modelLoaded = true;
            document.getElementById('runBtn').disabled = false;
        }
        
        async function runFullSimulation() {
            if (!modelLoaded) return;
            
            const cfu_init = document.getElementById('cfu_init').value;
            const dosing = generateDosingSchedule();
            const duration = document.getElementById('sim_duration').value;
            
            // R에서 전체 모델 실행
            const result = await webR.evalR(`
                # 초기값 설정 (전체 200개 상태변수)
                inits <- c(
                    AngI=8.164, AngII=5.17, AT1_bound_AngII=16.6, 
                    AT2_bound_AngII=5.5, plasma_renin_concentration=17.845,
                    blood_volume_L=5, extracellular_fluid_volume=15,
                    sodium_amount=700, ECF_sodium_amount=2100,
                    tubulo_glomerular_feedback_effect=1,
                    normalized_aldosterone_level_delayed=1,
                    preafferent_pressure_autoreg_signal=1,
                    glomerular_pressure_autoreg_signal=1,
                    cardiac_output_delayed=5,
                    CO_error=0, Na_concentration_error=0,
                    normalized_vasopressin_concentration_delayed=1,
                    F0_TGF=1.0183333333333333333333333333333e-14,
                    P_bowmans=14, oncotic_pressure_difference=28,
                    SN_macula_densa_Na_flow_delayed=5.0916666666666666666666666666666e-21,
                    serum_creatinine=4.6,
                    CFU_lung=${cfu_init}, CFU_blood=0, R_lung=1e6, R_blood=0,
                    CINC1=30, Lag1=0, Lag2=0, NS1=0, NS2=0, AC=48,
                    AT2=3e+10, AT1=2e+10, dAT1=250.26, dAT2=375.4,
                    pDC=0, pDC1=0, M1=0, Th1=0, Th17=0, Treg=0, N=2455.6,
                    TNFa=0.00024335, IL6=0.00014131, IL1b=0.028005,
                    IL2=0.35115, IL12=0, IL17=1.13E-05, IL10=0,
                    TGFb=0, GMCSF=0,
                    TNFa_c=1.54E-09, IL6_c=6.42E-08, IL1b_c=1.27E-05,
                    IL2_c=7.34E-06, IL12_c=8.93E-06, IL17_c=0,
                    IL10_c=9.72E-07, TGFb_c=8.11E-07, GMCSF_c=4.04E-06,
                    CRPExtracellular=0, Blood_CRP=0,
                    pDC_c=0.70096, M1_c=0.92091, N_c=0.48093,
                    Th1_c=0.7964, Th17_c=0.00017499, Treg_c=0.21768,
                    depot=0,
                    C_venous_vanco=0, C_vas_ki_vanco=0, C_vas_lu_vanco=0,
                    C_vas_ad_vanco=0, C_vas_bo_vanco=0, C_vas_go_vanco=0,
                    C_vas_he_vanco=0, C_vas_mu_vanco=0, C_vas_sk_vanco=0,
                    C_vas_br_vanco=0, C_vas_li_vanco=0, C_vas_re_vanco=0,
                    C_vas_gu_vanco=0, C_vas_sp_vanco=0, C_arterial_vanco=0
                )
                
                # 이벤트 테이블 생성
                ev1 <- eventTable(amount.units="mg", time.units="hours")
                
                # JavaScript에서 전달받은 투여 스케줄 적용
                ${dosing.map(d => `ev1$add.dosing(dose=${d.amount}, start.time=${d.time}, nbr.doses=1, cmt="depot")`).join('\n')}
                
                # 샘플링 시점 설정
                ev1$add.sampling(seq(0, ${duration}, by=0.5))
                
                # 전체 모델 실행
                x <- m1$run(theta, ev1, inits=inits)
                
                # 결과를 JavaScript로 전달
                list(
                    time = as.numeric(x[,"time"]),
                    CFU_lung = as.numeric(x[,"CFU_lung"]),
                    IL1b_pg_mL = as.numeric(x[,"IL1b_pg_mL"]),
                    IL6_pg_mL = as.numeric(x[,"IL6_pg_mL"]),
                    TNFa_pg_mL = as.numeric(x[,"TNFa_pg_mL"]),
                    IL10_pg_mL = as.numeric(x[,"IL10_pg_mL"]),
                    MAP = as.numeric(x[,"mean_arterial_pressure_MAP"]),
                    GFR = as.numeric(x[,"GFR_ml_min"]),
                    Scr = as.numeric(x[,"serum_creatinine_concentration"]),
                    CRP = as.numeric(x[,"CRP_mg_dl"]),
                    N_c = as.numeric(x[,"N_c"]),
                    cardiac_output = as.numeric(x[,"cardiac_output"])
                )
            `);
            
            const data = await result.toJs();
            displayResults(data);
        }
        
        // 페이지 로드 시 모델 초기화
        window.addEventListener('load', initializeModel);
        window.runSimulation = runFullSimulation;
    </script>
</body>
</html>
